<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß</title>
</head>
<body>

<h1 id="msg">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h1>
<button onclick="enableSound()">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>

<audio id="ding" src="ding.mp3"></audio>

<script src="firebase.js"></script>

<script type="module">
import {
  collection, query, where, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const db = window.db;
const token = new URLSearchParams(location.search).get("token");
let soundReady = false;

window.enableSound = () => {
  document.getElementById("msg").innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß...";
  soundReady = true;
};

const q = query(
  collection(db, "queues"),
  where("token", "==", token)
);

onSnapshot(q, (snap) => {
  if (snap.empty) {
    document.body.innerHTML = "<h1>QR ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h1>";
    return;
  }

  const data = snap.docs[0].data();

  if (data.used && data.status !== "called") {
    document.body.innerHTML = "<h1>QR ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß</h1>";
    return;
  }

  if (data.status === "called" && soundReady) {
    document.getElementById("ding").play();
    document.body.innerHTML = "<h1>üî• ‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß üî•</h1>";
  }
});
</script>

</body>
</html>